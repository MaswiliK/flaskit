name: FlaskIt CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# ── Stage 1: lint + import check (fast gate) ──────────────────────────
jobs:
  lint:
    name: Lint & import check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install package
        run: |
          python -m pip install --upgrade pip
          pip install .

      - name: Verify CLI loads
        run: python -c "from flaskit.cli import app; print('Import OK')"

      - name: Verify --help works
        run: python -m flaskit --help

  # ── Stage 2: cross-platform template tests (depends on lint) ────────
  test:
    name: "Test · ${{ matrix.os }} · py${{ matrix.python-version }}"
    needs: lint
    runs-on: ${{ matrix.os }}
    env:
      PYTHONUTF8: "1"
      PYTHONIOENCODING: "utf-8"

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ["3.9", "3.10", "3.11", "3.12"]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install package
        run: |
          python -m pip install --upgrade pip
          pip install .

      - name: Ensure UTF-8 codepage on Windows
        if: matrix.os == 'windows-latest'
        run: chcp 65001
        shell: cmd

      - name: Test MVP template
        shell: python
        run: |
          import subprocess, pathlib, sys

          subprocess.run(
              [sys.executable, "-m", "flaskit", "create", "test_mvp",
               "--template", "mvp", "--gitignore", "--readme",
               "--dockerfile", "--env-file"],
              check=True,
          )

          root = pathlib.Path("test_mvp")
          assert root.is_dir(), "test_mvp/ not created"

          expected = [
              "main.py",
              "app/__init__.py",
              "app/views.py",
              "app/auth.py",
              "app/models.py",
              "app/forms.py",
              "app/templates/layout.html",
              ".gitignore",
              "README.md",
              "Dockerfile",
              ".env",
          ]
          for f in expected:
              assert (root / f).is_file(), f"Missing: {f}"

          dockerfile = (root / "Dockerfile").read_text()
          assert "main.py" in dockerfile, "Dockerfile should reference main.py for MVP"

          env = (root / ".env").read_text()
          assert "FLASK_APP=main.py" in env, ".env should reference main.py for MVP"

          print("MVP template: all checks passed")

      - name: Test SaaS template
        shell: python
        run: |
          import subprocess, pathlib, sys

          subprocess.run(
              [sys.executable, "-m", "flaskit", "create", "test_saas",
               "--template", "saas", "--db", "postgresql", "--gitignore",
               "--readme", "--dockerfile", "--env-file"],
              check=True,
          )

          root = pathlib.Path("test_saas")
          assert root.is_dir(), "test_saas/ not created"

          expected = [
              "run.py",
              "config.py",
              "requirements.txt",
              "app/__init__.py",
              "app/extensions.py",
              "app/auth/routes.py",
              "app/auth/models.py",
              "app/auth/forms.py",
              "app/Feature1/routes.py",
              "app/Feature1/models.py",
              "app/Feature1/services.py",
              "app/Feature2/routes.py",
              "app/Feature3/routes.py",
              "app/templates/base.html",
              "app/tests/test_app.py",
              ".gitignore",
              "README.md",
              "Dockerfile",
              ".env",
          ]
          for f in expected:
              assert (root / f).is_file(), f"Missing: {f}"

          init_py = (root / "app/__init__.py").read_text()
          assert "register_blueprint" in init_py, "app/__init__.py must register blueprints"

          dockerfile = (root / "Dockerfile").read_text()
          assert "run.py" in dockerfile, "Dockerfile should reference run.py for SaaS"

          env = (root / ".env").read_text()
          assert "postgresql" in env, ".env should contain postgresql connection string"

          print("SaaS template: all checks passed")

      - name: Test input validation
        shell: python
        run: |
          import subprocess, sys

          # Unknown template should not crash
          result = subprocess.run(
              [sys.executable, "-m", "flaskit", "create", "test_fallback",
               "--template", "bogus"],
              capture_output=True, text=True,
          )
          assert result.returncode == 0, f"Unknown template caused crash: {result.stderr}"

          # Unknown db should not crash
          result = subprocess.run(
              [sys.executable, "-m", "flaskit", "create", "test_fallback_db",
               "--db", "mysql"],
              capture_output=True, text=True,
          )
          assert result.returncode == 0, f"Unknown db caused crash: {result.stderr}"

          print("Input validation: all checks passed")

      - name: Test skip on existing files
        shell: python
        run: |
          import subprocess, sys

          # Create project twice — second run should skip existing files, not crash
          subprocess.run(
              [sys.executable, "-m", "flaskit", "create", "test_skip"],
              check=True,
          )
          result = subprocess.run(
              [sys.executable, "-m", "flaskit", "create", "test_skip"],
              capture_output=True, text=True,
          )
          assert result.returncode == 0, f"Re-run on existing dir crashed: {result.stderr}"

          print("Skip existing: all checks passed")

  # ── Stage 3: demo smoke test — Linux only (depends on test) ─────────
  demo:
    name: Demo smoke test
    needs: test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install package
        run: |
          python -m pip install --upgrade pip
          pip install .
          pip install flask

      - name: Run demo and verify
        shell: python
        run: |
          import subprocess, pathlib, sys, time, signal

          # Start demo in background
          proc = subprocess.Popen(
              [sys.executable, "-m", "flaskit", "demo"],
              stdout=subprocess.PIPE, stderr=subprocess.PIPE,
          )

          # Wait for scaffolding to finish
          time.sleep(5)

          # Verify project was created
          root = pathlib.Path("hello-flaskit")
          assert root.is_dir(), "hello-flaskit/ not created"
          assert (root / "main.py").is_file(), "main.py not created"
          assert (root / "app/__init__.py").is_file(), "app/__init__.py not created"

          # Clean up server
          proc.terminate()
          try:
              proc.wait(timeout=5)
          except subprocess.TimeoutExpired:
              proc.kill()

          print("Demo smoke test: passed")
